import datetime

from django.conf import settings
from django.db.models import Count, Max, Q
from backend.models import ProjectVulnerability, Finding, Host, WebApplication, Membership, ProjectScope, ChangeHistory
from backend.models.vulnerability import Severity
from pecoret.reporting.template import ProjectPDFTemplate
from .base import DefaultBaseTemplate
from .charts import FindingBarChart


class PentestPDFReport(ProjectPDFTemplate, DefaultBaseTemplate):
    template_file = "pentest_report.html"
    default_title = "Pentest Report"

    def pre_processing(self, *args, **kwargs):
        super().pre_processing(*args, **kwargs)
        self.initialize_fonts(self.template_dir)

    def get_assets(self):
        assets = []
        assets += list(Host.objects.for_project(self.get_project()))
        assets += list(WebApplication.objects.for_project(self.get_project()))
        return assets

    def get_context(self):
        context = super().get_context()
        context["now"] = datetime.datetime.now().strftime("%B %d, %Y")
        context["REPORT_COMPANY_INFORMATION"] = settings.REPORT_COMPANY_INFORMATION
        context["findings"] = Finding.objects.for_report(self.get_project())
        context["members"] = Membership.objects.for_project(self.get_project()).for_report()
        context['vulnerabilities'] = ProjectVulnerability.objects.for_project(self.get_project()).filter(
            pk__in=context['findings'].values('vulnerability'))
        context["scopes"] = ProjectScope.objects.for_project(self.get_project())
        context["charts"] = {
            'findings_bar': FindingBarChart(context['findings'], self.config),
        }
        context["project"] = self.get_project()
        context["report_document"] = self.report_document
        return context

    def get_unique_vulnerabilities_by_severity(self):
        return (
            ProjectVulnerability.objects.for_project(project=self.get_project())
            .annotate(
                count=Count(
                    "finding__pk", distinct=True, filter=~Q(exclude_from_report=True)
                )
            )
            .annotate(finding_severity=Max("finding__severity"))
            .order_by("-finding__severity", "vulnerability_id")
            .filter(count__gt=0)
        )

    def get_vulnerabilities(self):
        return ProjectVulnerability.objects.for_project(
            project=self.get_project()
        ).filter(finding__is_null=False)

    def get_findings_count_for_asset(self, asset, severity=None):
        qs = asset.findings.exclude(exclude_from_report=True)
        if severity:
            qs = qs.filter(severity=Severity[severity].value)
        return qs.count()

    def check_report_errors(self):
        self.check_finding_errors()
        if not self.report_document.report.recommendation:
            self.add_report_error("Missing recommendation!", "#executive-summary-recommendation")
        if not self.report_document.report.evaluation:
            self.add_report_error("Missing evaluation!", "#executive-summary-evaluation")
        if not self.report_document.report.changehistory_set.count():
            self.add_report_error("Change History missing!", "#change-history-table")

    @property
    def version(self):
        qs = ChangeHistory.objects.filter(report=self.report_document.report)
        if qs.exists():
            return qs.order_by("-version").first()
        return "0.1"

    @property
    def title(self):
        custom_title = self.report_document.report.title
        if not custom_title:
            return self.default_title
        return custom_title
