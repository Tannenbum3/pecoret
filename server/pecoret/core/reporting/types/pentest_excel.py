import io
from openpyxl import Workbook
from backend import models
from .base import ProjectRelatedReportType


class PentestExcelReport(ProjectRelatedReportType):
    content_type = "application/vnd.ms-excel"
    file_extension = "xlsx"
    default_title = "Pentest Excel"

    def render_report(self):
        workbook = Workbook()
        ws = workbook.active
        ws.title = "Findings"
        ws['A1'] = "ID"
        ws['B1'] = 'Name'
        ws['C1'] = 'Vulnerability'
        ws['D1'] = 'Severity'
        ws['E1'] = 'Component'
        ws['F1'] = 'Description'
        ws['G1'] = 'Recommendation'
        ws['H1'] = 'Status'
        for finding in models.Finding.objects.for_project(self.get_project()):
            if finding.recommendation:
                recommendation = finding.recommendation
            else:
                recommendation = finding.vulnerability.recommendation
            ws.append([
                finding.internal_id,
                finding.name,
                finding.vulnerability.name,
                finding.get_severity_display(),
                str(finding.component),
                finding.vulnerability.description,
                recommendation,
                finding.get_status_display()
            ])
        f = io.BytesIO()
        workbook.save(f)
        return f.getvalue()

    def get_context(self):
        context = super().get_context()
        return context
